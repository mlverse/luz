<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Checkpointing your models • luz</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Checkpointing your models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">luz</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Using luz</h6></li>
    <li><a class="dropdown-item" href="../articles/get-started.html">Get started</a></li>
    <li><a class="dropdown-item" href="../articles/custom-loop.html">Custom loops</a></li>
    <li><a class="dropdown-item" href="../articles/accelerator.html">Accelerator API</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/lr-finder.html">Using the lr_finder</a></li>
    <li><a class="dropdown-item" href="../articles/checkpoints.html">Checkpoints models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/examples/index.html">Examples</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlverse/luz/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Checkpointing your models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlverse/luz/blob/main/vignettes/articles/checkpoints.Rmd" class="external-link"><code>vignettes/articles/checkpoints.Rmd</code></a></small>
      <div class="d-none name"><code>checkpoints.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlverse.github.io/luz/">luz</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_manual_seed.html" class="external-link">torch_manual_seed</a></span><span class="op">(</span><span class="fl">1703</span><span class="op">)</span></span></code></pre></div>
<p>When fitting models take too long you might want to save intermediate
state to disk, if something goes wrong during training (eg. process is
killed, network fails, etc) you can recover from where it stopped.</p>
<p>You might also want to recover intermediate results to evaluate the
model in different moments of the training, like comparing results after
10 epochs and after 30 epochs.</p>
<p>This article describes luz features that are built to handle those
cases. These features are optional and are enabled once you add specific
callbacks to your <code>fit</code> call.</p>
<div class="section level2">
<h2 id="resuming-training-runs-that-crashed">Resuming training runs that crashed<a class="anchor" aria-label="anchor" href="#resuming-training-runs-that-crashed"></a>
</h2>
<p>If you have a long training run that can crash for whatever reason
(computer turned off, process kileed in cluster, etc), we recommend you
to add <code>luz_callback_autoresume()</code> to your list of
callbacks.</p>
<p><code>luz_callback_autoresume()</code> will automatically checkpoint
the whole state of your model at the end of each epoch. If something
fails during training you can simply rerun the same script, whithout any
code changes and the checkpoint will be reloaded and the training will
start from where it stopped.</p>
<p>For example, lets’s take a randomly generated training dataset and a
linear model to show how autoresume works.</p>
<p>Here’s the training data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>And the model definition:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">nn_linear</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/setup.html">setup</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="va">optim_sgd</span>, loss <span class="op">=</span> <span class="va">nnf_mse_loss</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/set_hparams.html">set_hparams</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">10</span>, out_features <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/set_opt_hparams.html">set_opt_hparams</a></span><span class="op">(</span>lr <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<p>Let’s now create a callback that simulates a random failure that
could happen. This callback will just raise an R error on the 5th
epoch.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interrupt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback.html">luz_callback</a></span><span class="op">(</span></span>
<span>  <span class="st">"interrupt"</span>,</span>
<span>  failed <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  on_epoch_end <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="va">self</span><span class="op">$</span><span class="va">failed</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">failed</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Error on epoch 5"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Let’s now start training adding the
<code><a href="../reference/luz_callback_auto_resume.html">luz_callback_auto_resume()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">autoresume</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback_auto_resume.html">luz_callback_auto_resume</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"state.pt"</span><span class="op">)</span></span>
<span><span class="va">inter</span> <span class="op">&lt;-</span> <span class="fu">interrupt</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># An error will happen in the 5th epoch and the model will be stopped.</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">inter</span>, <span class="va">autoresume</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `FUN()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Error while calling callback with class <span style="color: #0000BB;">&lt;interrupt/LuzCallback/R6&gt;</span> at</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">on_epoch_end</span>.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Caused by error in `self[[callback_nm]]()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Error on epoch 5</span></span></code></pre></div>
<p>To resume model training exactly from where it stopped you just need
to restart fitting, using the exact same model, callbacks, etc:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">inter</span>, <span class="va">autoresume</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>With this, the model fitting process will be continued exactly from
where it stopped. Records, optimizer and model state are recovered from
the previous run so you can have the full results:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></code></pre></div>
<p><img src="checkpoints_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="checkpointing">Checkpointing<a class="anchor" aria-label="anchor" href="#checkpointing"></a>
</h2>
<p>Sometimes you want to have more control over how checkpoints are
handled. In this case you can use
<code><a href="../reference/luz_callback_model_checkpoint.html">luz_callback_model_checkpoint()</a></code> to save checkpoints to a
specified file or directory.</p>
<p>Let’s use the same example as in the resuming section: We first
generate some data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Then define our model:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">nn_linear</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/setup.html">setup</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="va">optim_sgd</span>, loss <span class="op">=</span> <span class="va">nnf_mse_loss</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/set_hparams.html">set_hparams</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">10</span>, out_features <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/set_opt_hparams.html">set_opt_hparams</a></span><span class="op">(</span>lr <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<p>Let’s now fit the model using
<code><a href="../reference/luz_callback_model_checkpoint.html">luz_callback_model_checkpoint()</a></code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">checkpoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback_model_checkpoint.html">luz_callback_model_checkpoint</a></span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="st">"checkpoints/"</span>, </span>
<span>  monitor <span class="op">=</span> <span class="st">"train_loss"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">checkpoint</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You can see now that the <code>checkpoints</code> directory contains
files with state dumps for each epoch. By default,
<code>luz_callback_model_checkpoint</code> will save the state for each
epochs and format the name including the resulting loss. This can be
configured withing the path parameter, see
<code><a href="../reference/luz_callback_model_checkpoint.html">?luz_callback_model_checkpoint</a></code> for details.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="st">"checkpoints"</span><span class="op">)</span></span>
<span><span class="co">#&gt; checkpoints/epoch-01-train_loss-1.237.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-02-train_loss-1.065.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-03-train_loss-1.026.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-04-train_loss-1.004.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-05-train_loss-1.004.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-06-train_loss-1.005.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-07-train_loss-0.999.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-08-train_loss-0.998.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-09-train_loss-1.001.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-10-train_loss-1.002.pt</span></span></code></pre></div>
<p>Finally, you can load a specific checkpoint to the
<code>fitted</code> result using <code>luz_load_checkpoint</code>. Note
that loading the checkpoint into a a <code>luz_fitted_module</code> is
going to modify the model weights in-place.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/luz_load_checkpoint.html">luz_load_checkpoint</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="st">"checkpoints"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>You can then start making predictions, or evaluate your model using
the reloeded weights.</p>
<p>You might also want to start a new training run from a checkpoint.
For this, you can use the
<code><a href="../reference/luz_callback_resume_from_checkpoint.html">luz_callback_resume_from_checkpoint()</a></code>. By default, it will
only recover the model weights from the checkpoint file, but you can
configure it to restore records, callback and optimizer state too. If a
checkpoint directory is passed then training will resume from the last
checkpoint file as returned by <code><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">fs::dir_ls</a></code>.</p>
<p>Here’s how you would use this callback:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resume</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback_resume_from_checkpoint.html">luz_callback_resume_from_checkpoint</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"checkpoints/"</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">resume</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></code></pre></div>
<p><img src="checkpoints_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="section level3">
<h3 id="custom-callbacks-state">Custom callbacks state<a class="anchor" aria-label="anchor" href="#custom-callbacks-state"></a>
</h3>
<p>Sometimes callbacks also need to keep their internal state in order
to allow continuing training exactly from where it stopped. In this
case, callbacks can implement the <code>state_dict()</code> and the
<code><a href="https://torch.mlverse.org/docs/reference/load_state_dict.html" class="external-link">load_state_dict()</a></code> methods that are automatically called
when saving and reloading checkpoints.</p>
<p>For example, suppose that you have a callback that tracks gradients
for weights at every epoch. You want to use the tracked weights to
further analyse the training procedure. It could be implemented
like:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cb_weight_grad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback.html">luz_callback</a></span><span class="op">(</span></span>
<span>  <span class="st">"weight_grad"</span>,</span>
<span>  gradients <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">track_weights</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">track_weights</span></span>
<span>  <span class="op">}</span>,</span>
<span>  on_train_batch_before_step <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gradients</span><span class="op">[[</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">w</span> <span class="kw">in</span> <span class="va">self</span><span class="op">$</span><span class="va">track_weights</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">gradients</span><span class="op">[[</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">w</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">[[</span><span class="va">w</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In the above example, the <code>gradients</code> field is a
<strong>state</strong> in the callback. If training fails for some
reason, <code>gradients</code> will be lost. If it’s important for you
to also checkpoint the callback state, you can implement the
<code>state_dict()</code> method must returning a named list of objects
that compose the state of the callback and
<code><a href="https://torch.mlverse.org/docs/reference/load_state_dict.html" class="external-link">load_state_dict()</a></code> taking the same named list returned by
<code>state_dict()</code> and restoring the callback state.</p>
<p>The callback above could be reimplemented with:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cb_weight_grad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback.html">luz_callback</a></span><span class="op">(</span></span>
<span>  <span class="st">"weight_grad"</span>,</span>
<span>  gradients <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">track_weights</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">track_weights</span></span>
<span>  <span class="op">}</span>,</span>
<span>  on_train_batch_before_step <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gradients</span><span class="op">[[</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">w</span> <span class="kw">in</span> <span class="va">self</span><span class="op">$</span><span class="va">track_weights</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">gradients</span><span class="op">[[</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">w</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">[[</span><span class="va">w</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>,</span>
<span>  state_dict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gradients <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">gradients</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  load_state_dict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">gradients</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">gradients</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel Falbel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
