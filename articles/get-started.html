<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Get started with luz â€¢ luz</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Get started with luz">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">luz</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Using luz</h6></li>
    <li><a class="dropdown-item" href="../articles/get-started.html">Get started</a></li>
    <li><a class="dropdown-item" href="../articles/custom-loop.html">Custom loops</a></li>
    <li><a class="dropdown-item" href="../articles/accelerator.html">Accelerator API</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/lr-finder.html">Using the lr_finder</a></li>
    <li><a class="dropdown-item" href="../articles/checkpoints.html">Checkpoints models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/examples/index.html">Examples</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlverse/luz/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Get started with luz</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlverse/luz/blob/main/vignettes/get-started.Rmd" class="external-link"><code>vignettes/get-started.Rmd</code></a></small>
      <div class="d-none name"><code>get-started.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlverse.github.io/luz/">luz</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span></code></pre></div>
<p>Luz is a high-level API for torch that aims to encapsulate the
<strong>training loop</strong> into a set of reusable pieces of code.
Luz reduces the boilerplate code required to train a model with torch
and avoids the error prone <code>zero_grad()</code> -
<code>backward()</code> - <code><a href="https://rdrr.io/r/stats/step.html" class="external-link">step()</a></code> sequence of calls, and
also simplifies the process of moving data and models between CPUs and
GPUs. Luz is designed to be highly flexible by providing a layered API
that allows it to be useful no matter the level of control you need for
your training loop.</p>
<p>Luz is heavily inspired by other higher level frameworks for deep
learning, to cite a few:</p>
<ul>
<li><p><a href="https://docs.fast.ai/" class="external-link">FastAI</a>: we are heavily
inspired by the FastAI library, especially the <code>Learner</code>
object and the callbacks API.</p></li>
<li><p><a href="https://keras.io/" class="external-link">Keras</a>: We are also heavily
inspired by Keras, especially callback names. The lightning module
interface is similar to <code>compile</code>, too.</p></li>
<li><p><a href="https://lightning.ai/pages/open-source/" class="external-link">PyTorch
Lightning</a>: The idea of the <code>luz_module</code> being a subclass
of <code>nn_module</code> is inspired by the
<strong><code>LightningModule</code></strong> object in
lightning.</p></li>
<li><p><a href="https://huggingface.co/docs/accelerate/" class="external-link">HuggingFace
Accelerate</a>: The internal device placement API is heavily inspired by
Accelerate, but is much more modest in features. Currently only CPU and
Single GPU are supported.</p></li>
</ul>
<div class="section level2">
<h2 id="training-a-nn_module">Training a <code>nn_module</code><a class="anchor" aria-label="anchor" href="#training-a-nn_module"></a>
</h2>
<p>As much as possible, luz tries to reuse the existing structures from
torch. A model in luz is defined identically as you would define it if
using raw torch. For a specific example, this is the definition of a
feed-forward CNN that can be used to classify digits from the MNIST
dataset:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  <span class="st">"Net"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">num_class</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">conv1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_conv2d.html" class="external-link">nn_conv2d</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">32</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">conv2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_conv2d.html" class="external-link">nn_conv2d</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">64</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">dropout1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_dropout2d.html" class="external-link">nn_dropout2d</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">dropout2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_dropout2d.html" class="external-link">nn_dropout2d</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">fc1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">9216</span>, <span class="fl">128</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">fc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">128</span>, <span class="va">num_class</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">conv1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html" class="external-link">nnf_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">conv2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html" class="external-link">nnf_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_max_pool2d.html" class="external-link">nnf_max_pool2d</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">dropout1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_flatten.html" class="external-link">torch_flatten</a></span><span class="op">(</span><span class="va">x</span>, start_dim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">fc1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html" class="external-link">nnf_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">dropout2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">fc2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can now train this model in the <code>train_dl</code> and validate
it in the <code>test_dl</code> <code>torch::dataloaders()</code>
with:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted</span> <span class="op">&lt;-</span> <span class="va">net</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/setup.html">setup</a></span><span class="op">(</span></span>
<span>    loss <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_cross_entropy_loss.html" class="external-link">nn_cross_entropy_loss</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    optimizer <span class="op">=</span> <span class="va">optim_adam</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="va">luz_metric_accuracy</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/set_hparams.html">set_hparams</a></span><span class="op">(</span>num_class <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/set_opt_hparams.html">set_opt_hparams</a></span><span class="op">(</span>lr <span class="op">=</span> <span class="fl">0.003</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">train_dl</span>, epochs <span class="op">=</span> <span class="fl">10</span>, valid_data <span class="op">=</span> <span class="va">test_dl</span><span class="op">)</span></span></code></pre></div>
<p>Letâ€™s understand what happens in this chunk of code:</p>
<ol style="list-style-type: decimal">
<li>The <code>setup</code> function allows you to configure the loss
(objective) function and the optimizer that you will use to train your
model. Optionally you can pass a list of metrics that are tracked during
the training procedure. <strong>Note:</strong> the loss function can be
any function taking <code>input</code> and <code>target</code> tensors
and returning a scalar tensor value, and the optimizer can be any core
torch optimizer or custom ones created with the
<code><a href="https://torch.mlverse.org/docs/reference/optimizer.html" class="external-link">torch::optimizer()</a></code> function.</li>
<li>The <code><a href="../reference/set_hparams.html">set_hparams()</a></code> function allows you to set
hyper-parameters that should be passed to the module
<code>initialize()</code> method. For example in this case we pass
<code>num_classes = 10</code>.</li>
<li>The <code><a href="../reference/set_opt_hparams.html">set_opt_hparams()</a></code> function allows you to pass
hyper-parameters that are used by the optimizer function. For example,
<code><a href="https://torch.mlverse.org/docs/reference/optim_adam.html" class="external-link">optim_adam()</a></code> can take the <code>lr</code> parameter
specifying the learning rate and we specify it with
<code>lr = 0.003</code>.</li>
<li>The <code>fit</code> method will take the model specification
provided by <code><a href="../reference/setup.html">setup()</a></code> and run the training procedure using
the specified training and validation <code>torch::dataloaders()</code>
as well as the number of epochs. <strong>Note:</strong> we again reuse
core torch data structures, instead of providing our own data loading
functionality.</li>
<li>The returned object <code>fitted</code> contains the trained model
as well as the record of metrics and losses produced during training. It
can also be used for producing predictions and for evaluating the
trained model on other datasets.</li>
</ol>
<p>When fitting, luz will use the fastest possible accelerator; if a
CUDA-capable GPU is available it will be used, otherwise we fall back to
the CPU. It also automatically moves data, optimizers, and models to the
selected device so you donâ€™t need to handle it manually (which is in
general very error prone).</p>
<p>To create predictions from the trained model you can use the
<code>predict</code> method:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fitted</span>, <span class="va">test_dl</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-training-loop">The training loop<a class="anchor" aria-label="anchor" href="#the-training-loop"></a>
</h2>
<p>You now have a general idea of how to use the <code>fit</code>
function and now itâ€™s important to have an overview of whatâ€™s happening
inside it. In pseudocode, hereâ€™s what <code>fit</code> does. This is not
fully detailed but should help you to build your intuition:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># -&gt; Initialize objects: model, optimizers.</span></span>
<span><span class="co"># -&gt; Select fitting device.</span></span>
<span><span class="co"># -&gt; Move data, model, optimizers to the selected device.</span></span>
<span><span class="co"># -&gt; Start training</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># -&gt; Training procedure</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">train_dl</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># -&gt; Calculate model `forward` method.</span></span>
<span>    <span class="co"># -&gt; Calculate the loss</span></span>
<span>    <span class="co"># -&gt; Update weights</span></span>
<span>    <span class="co"># -&gt; Update metrics and tracking loss</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># -&gt; Validation procedure</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">valid_dl</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># -&gt; Calculate model `forward` method.</span></span>
<span>    <span class="co"># -&gt; Calculate the loss</span></span>
<span>    <span class="co"># -&gt; Update metrics and tracking loss</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># -&gt; End training</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="metrics">Metrics<a class="anchor" aria-label="anchor" href="#metrics"></a>
</h2>
<p>One of the most important parts in machine learning projects is
choosing the evaluation metric. Luz allows tracking many different
metrics during training with minimal code changes.</p>
<p>In order to track metrics, you only need to modify the
<code>metrics</code> parameter in the <code>setup</code> function:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>fitted <span class="ot">&lt;-</span> net <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="fu">setup</span>(</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    ...</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">list</span>(</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>      luz_metric_accuracy</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    )</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>  <span class="fu">fit</span>(...)</span></code></pre></div>
<p>Luz provides implementations of a few of the most used metrics. If a
metric is not available you can always implement a new one using the
<code>luz_metric</code> function.</p>
<p>In order to implement a new <code>luz_metric</code> we need to
implement 3 methods:</p>
<ul>
<li><p><code>initialize</code>: defines the metric initial state. This
function is called for each epoch for both training and validation
loops.</p></li>
<li><p><code>update</code>: updates the metric internal state. This
function is called at every training and validation step with the
predictions obtained by the model and the target values obtained from
the dataloader.</p></li>
<li><p><code>compute</code>: uses the internal state to compute metric
values. This function is called whenever we need to obtain the current
metric value. Eg, itâ€™s called every training step for metrics displayed
in the progress bar, but only called once per epoch to record itâ€™s value
when the progress bar is not displayed.</p></li>
</ul>
<p>Optionally, you can implement an <code>abbrev</code> field that gives
the metric an abbreviation that will be used when displaying metric
information in the console or tracking record. If no <code>abbrev</code>
is passed, the class name will be used.</p>
<p>Letâ€™s take a look at the implementation of
<code>luz_metric_accuracy</code> so you can see how to implement a new
one:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">luz_metric_accuracy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_metric.html">luz_metric</a></span><span class="op">(</span></span>
<span>  <span class="co"># An abbreviation to be shown in progress bars, or </span></span>
<span>  <span class="co"># when printing progress</span></span>
<span>  abbrev <span class="op">=</span> <span class="st">"Acc"</span>, </span>
<span>  <span class="co"># Initial setup for the metric. Metrics are initialized</span></span>
<span>  <span class="co"># every epoch, for both training and validation</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">correct</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">total</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span>,</span>
<span>  <span class="co"># Run at every training or validation step and updates</span></span>
<span>  <span class="co"># the internal state. The update function takes `preds`</span></span>
<span>  <span class="co"># and `target` as parameters.</span></span>
<span>  update <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">preds</span>, <span class="va">target</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_argmax.html" class="external-link">torch_argmax</a></span><span class="op">(</span><span class="va">preds</span>, dim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">correct</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">correct</span> <span class="op">+</span> <span class="op">(</span><span class="va">pred</span> <span class="op">==</span> <span class="va">target</span><span class="op">)</span><span class="op">$</span></span>
<span>      <span class="fu">to</span><span class="op">(</span>dtype <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_dtype.html" class="external-link">torch_float</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">$</span></span>
<span>      <span class="fu">sum</span><span class="op">(</span><span class="op">)</span><span class="op">$</span></span>
<span>      <span class="fu">item</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">total</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">total</span> <span class="op">+</span> <span class="va">pred</span><span class="op">$</span><span class="fu">numel</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  <span class="co"># Use the internal state to query the metric value</span></span>
<span>  compute <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">correct</span><span class="op">/</span><span class="va">self</span><span class="op">$</span><span class="va">total</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Note</strong>: Itâ€™s good practice that the
<code>compute</code> metric returns regular R values instead of torch
tensors and other parts of luz will expect that.</p>
</div>
<div class="section level2">
<h2 id="evaluate">Evaluate<a class="anchor" aria-label="anchor" href="#evaluate"></a>
</h2>
<p>Once a model has been trained you might want to evaluate its
performance on a different dataset. For that reason, luz provides the
<code><a href="../reference/evaluate.html">?evaluate</a></code> function that takes a fitted model and a dataset
and computes the metrics attached to the model.</p>
<p>Evaluate returns a <code>luz_module_evaluation</code> object that you
can query for metrics using the <code>get_metrics</code> function or
simply <code>print</code> to see the results.</p>
<p>For example:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">evaluation</span> <span class="op">&lt;-</span> <span class="va">fitted</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/evaluate.html">evaluate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">valid_dl</span><span class="op">)</span></span>
<span><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_metrics.html">get_metrics</a></span><span class="op">(</span><span class="va">evaluation</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">evaluation</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; A `luz_module_evaluation`</span></span>
<span><span class="co">#&gt; -- Results ---------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; loss: 1.8892</span></span>
<span><span class="co">#&gt; mae: 1.0522</span></span>
<span><span class="co">#&gt; mse: 1.645</span></span>
<span><span class="co">#&gt; rmse: 1.2826</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="customizing-with-callbacks">Customizing with callbacks<a class="anchor" aria-label="anchor" href="#customizing-with-callbacks"></a>
</h2>
<p>Luz provides different ways to customize the training progress
depending on the level of control you need in the training loop. The
fastest way and the more â€˜reusableâ€™, in the sense that you can create
training modifications that can be used in many different situations, is
via <strong>callbacks</strong>.</p>
<p>The training loop in luz has many <em>breakpoints</em> that can call
arbitrary R functions. This functionality allows you to customize the
training process without having to modify the general training
logic.</p>
<p>Luz implements 3 default callbacks that occur in every training
procedure:</p>
<ul>
<li><p><strong>train-eval callback</strong>: Sets the model to
<code>train()</code> or <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval()</a></code> depending on if the
procedure is doing training or validation.</p></li>
<li><p><strong>metrics callback</strong>: evaluate metrics during
training and validation process.</p></li>
<li><p><strong>progress callback</strong>: implements a progress bar and
prints progress information during training.</p></li>
</ul>
<p>You can also implement custom callbacks that modify or act
specifically for your training procedure. For example:</p>
<p>Letâ€™s implement a callback that prints â€˜Iteration <code>n</code>â€™
(where <code>n</code> is the iteration number) for every batch in the
training set and â€˜Doneâ€™ when an epoch is finished. For that task we use
the <code>luz_callback</code> function:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print_callback</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback.html">luz_callback</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"print_callback"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">message</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">message</span> <span class="op">&lt;-</span> <span class="va">message</span></span>
<span>  <span class="op">}</span>,</span>
<span>  on_train_batch_end <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Iteration "</span>, <span class="va">ctx</span><span class="op">$</span><span class="va">iter</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  on_epoch_end <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">message</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/luz_callback.html">luz_callback()</a></code> takes named functions as <code>...</code>
arguments, where the name indicates the moment at which the callback
should be called. For instance <code>on_train_batch_end()</code> is
called for every batch at the end of the training procedure, and
<code>on_epoch_end()</code> is called at the end of every epoch.</p>
<p>The returned value of <code><a href="../reference/luz_callback.html">luz_callback()</a></code> is a function that
initializes an instance of the callback. Callbacks can have
initialization parameters, like the name of a file where you want to log
the results. In that case, you can pass an <code>initialize</code>
method when creating the callback definition, and save these parameters
to the <code>self</code> object. In the above example, the callback has
a <code>message</code> parameter that is printed at the end of each
epoch.</p>
<p>Once a callback is defined it can be passed to the <code>fit</code>
function via the <code>callbacks</code> parameter:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted</span> <span class="op">&lt;-</span> <span class="va">net</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/setup.html">setup</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">...</span>, callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu">print_callback</span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Done!"</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Callbacks can be called in many different positions of the training
loop, including combinations of them. Hereâ€™s an overview of possible
callback <em>breakpoints</em>:</p>
<pre><code>Start Fit
   - on_fit_begin
  Start Epoch Loop
     - on_epoch_begin
    Start Train
       - on_train_begin
      Start Batch Loop
         - on_train_batch_begin
          Start Default Training Step
            - on_train_batch_after_pred
            - on_train_batch_after_loss
            - on_train_batch_before_backward
            - on_train_batch_before_step
            - on_train_batch_after_step
          End Default Training Step:
         - on_train_batch_end
      End Batch Loop
       - on_train_end
    End Train
    Start Valid
       - on_valid_begin
      Start Batch Loop
         - on_valid_batch_begin
          Start Default Validation Step
            - on_valid_batch_after_pred
            - on_valid_batch_after_loss
          End Default Validation Step
         - on_valid_batch_end
      End Batch Loop
       - on_valid_end
    End Valid
      - on_epoch_end
  End Epoch Loop
   - on_fit_end
End Fit</code></pre>
<p>Every step marked with <code>on_*</code> is a point in the training
procedure that is available for callbacks to be called.</p>
<p>The other important part of callbacks is the <code>ctx</code>
(context) object. See <code><a href="../reference/ctx.html">help("ctx")</a></code> for details.</p>
<p>By default, callbacks are called in the same order as they were
passed to <code>fit</code> (or <code>predict</code> or
<code>evaluate</code>), but you can provide a <code>weight</code>
attribute that will control the order in which it will be called. For
example, if one callback has <code>weight = 10</code> and another has
<code>weight = 1</code>, then the first one is called after the second
one. Callbacks that donâ€™t specify a <code>weight</code> attribute are
considered <code>weight = 0</code>. A few built-in callbacks in luz
already provide a weight value. For example, the
<code><a href="../reference/luz_callback_early_stopping.html">?luz_callback_early_stopping</a></code> has a weight of
<code>Inf</code>, since in general we want to run it as the last thing
in the loop.</p>
<p>The <code>ctx</code> object is used in luz to share information
between the training loop and callbacks, model methods, and metrics. The
table below describes information available in the <code>ctx</code> by
default. Other callbacks could potentially modify these attributes or
add new ones.</p>
<!-- It's recommended to use the RStudio Visual editor to edit this table. -->
<table class="table">
<caption>Context attributes</caption>
<colgroup>
<col width="18%">
<col width="81%">
</colgroup>
<thead><tr class="header">
<th>Attribute</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>verbose</code></td>
<td>The value (<code>TRUE</code> or <code>FALSE</code>) attributed to
the <code>verbose</code> argument in <code>fit</code> .</td>
</tr>
<tr class="even">
<td><code>accelerator</code></td>
<td>Accelerator object used to query the correct device to place models,
data, etc. It assumes the value passed to the <code>accelerator</code>
parameter in <code>fit</code>.</td>
</tr>
<tr class="odd">
<td><code>model</code></td>
<td>Initialized <code>nn_module</code> object that will be trained
during the <code>fit</code> procedure.</td>
</tr>
<tr class="even">
<td><code>optimizers</code></td>
<td>A named list of optimizers used during training.</td>
</tr>
<tr class="odd">
<td><code>data</code></td>
<td>The currently in-use dataloader. When training itâ€™s
<code>ctx$train_data</code>, when doing validation its
<code>ctx$valid_data</code>. It can also be the prediction dataset when
in <code>predict</code>.</td>
</tr>
<tr class="even">
<td><code>train_data</code></td>
<td>Dataloader passed to the <code>data</code> argument in
<code>fit</code>. Modified to yield data in the selected device.</td>
</tr>
<tr class="odd">
<td><code>valid_data</code></td>
<td>Dataloader passed to the <code>valid_data</code> argument in
<code>fit</code>. Modified to yield data in the selected device.</td>
</tr>
<tr class="even">
<td><code>min_epochs</code></td>
<td>Minimum number of epochs the model will be trained for.</td>
</tr>
<tr class="odd">
<td><code>max_epochs</code></td>
<td>Maximum number of epochs the model will be trained for.</td>
</tr>
<tr class="even">
<td><code>epoch</code></td>
<td>Current training epoch.</td>
</tr>
<tr class="odd">
<td><code>iter</code></td>
<td>Current training iteration. Itâ€™s reset every epoch and when going
from training to validation.</td>
</tr>
<tr class="even">
<td><code>training</code></td>
<td>Whether the model is in training or validation mode. See also
<code><a href="../reference/luz_callback_train_valid.html">help("luz_callback_train_valid")</a></code>
</td>
</tr>
<tr class="odd">
<td><code>callbacks</code></td>
<td>List of callbacks that will be called during the training procedure.
Itâ€™s the union of the list passed to the <code>callbacks</code>
parameter and the default <code>callbacks</code>.</td>
</tr>
<tr class="even">
<td><code>step</code></td>
<td>Closure that will be used to do one <code>step</code> of the model.
Itâ€™s used for both training and validation. Takes no argument, but can
access the <code>ctx</code> object.</td>
</tr>
<tr class="odd">
<td><code>call_callbacks</code></td>
<td>Call callbacks by name. For example
<code>call_callbacks("on_train_begin")</code> will call all callbacks
that provide methods for this point.</td>
</tr>
<tr class="even">
<td><code>batch</code></td>
<td>Last batch obtained by the dataloader. A batch is a
<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code> with 2 elements, one that is used as
<code>input</code> and the other as <code>target</code>.</td>
</tr>
<tr class="odd">
<td><code>input</code></td>
<td>First element of the last batch obtained by the current
dataloader.</td>
</tr>
<tr class="even">
<td><code>target</code></td>
<td>Second element of the last batch obtained by the current
dataloader.</td>
</tr>
<tr class="odd">
<td><code>pred</code></td>
<td>Last predictions obtained by <code>ctx$model$forward</code> .
<strong>Note:</strong> can be potentially modified by previously ran
callbacks. Also note that this might not be available if you used a
custom training step.</td>
</tr>
<tr class="even">
<td><code>loss_fn</code></td>
<td>The active loss function that will be minimized during
training.</td>
</tr>
<tr class="odd">
<td><code>loss</code></td>
<td>Last computed loss from the model. <strong>Note:</strong> this might
not be available if you modified the training or validation step.</td>
</tr>
<tr class="even">
<td><code>opt</code></td>
<td>Current optimizer, ie. the optimizer that will be used to do the
next <code>step</code> to update parameters.</td>
</tr>
<tr class="odd">
<td><code>opt_nm</code></td>
<td>Current optimizer name. By default itâ€™s <code>opt</code> , but can
change if your model uses more than one optimizer depending on the set
of parameters being optimized.</td>
</tr>
<tr class="even">
<td><code>metrics</code></td>
<td>
<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code> with current metric objects that are
<code>update</code>d at every <code>on_train_batch_end()</code> or
<code>on_valid_batch_end()</code>. See also
<code><a href="../reference/luz_callback_metrics.html">help("luz_callback_metrics")</a></code>
</td>
</tr>
<tr class="odd">
<td><code>records</code></td>
<td>
<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code> recording metric values for training and
validation for each epoch. See also
<code><a href="../reference/luz_callback_metrics.html">help("luz_callback_metrics")</a></code> . Also records profiling
metrics. See <code><a href="../reference/luz_callback_profile.html">help("luz_callback_profile")</a></code> for more
information.</td>
</tr>
<tr class="even">
<td><code>handlers</code></td>
<td>A named <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code> of handlers that is passed to
<code><a href="https://rlang.r-lib.org/reference/with_handlers.html" class="external-link">rlang::with_handlers()</a></code> during the training loop and can be
used to handle errors or conditions that might be raised by other
callbacks.</td>
</tr>
<tr class="odd">
<td><code>epoch_handlers</code></td>
<td>A named list of handlers that is used with
<code><a href="https://rlang.r-lib.org/reference/with_handlers.html" class="external-link">rlang::with_handlers()</a></code>. Those handlers are used inside the
epochs loop, thus you can handle epoch specific conditions, that wonâ€™t
necessarily end training.</td>
</tr>
</tbody>
</table>
<p>Attributes in <code>ctx</code> can be used to produce the desired
behavior of callbacks. You can find information about the context object
using <code><a href="../reference/ctx.html">help("ctx")</a></code>. In our example, we use the
<code>ctx$iter</code> attribute to print the iteration number for each
training batch.</p>
</div>
<div class="section level2">
<h2 id="next-steps">Next steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<p>In this article you learned how to train your first model using luz
and the basics of customization using both custom metrics and
callbacks.</p>
<p>Luz also allows more flexible modifications of the training loop
described in <code><a href="../articles/custom-loop.html">vignette("custom-loop")</a></code>.</p>
<p>You should now be able to follow the examples marked with the â€˜basicâ€™
category in the <a href="https://mlverse.github.io/luz/articles/examples/index.html">examples
gallery</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel Falbel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
