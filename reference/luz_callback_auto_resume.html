<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Resume training callback — luz_callback_auto_resume • luz</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Resume training callback — luz_callback_auto_resume"><meta name="description" content="This callback allows you to resume training a model."><meta property="og:description" content="This callback allows you to resume training a model."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">luz</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><h6 class="dropdown-header" data-toc-skip>Using luz</h6></li>
    <li><a class="dropdown-item" href="../articles/get-started.html">Get started</a></li>
    <li><a class="dropdown-item" href="../articles/custom-loop.html">Custom loops</a></li>
    <li><a class="dropdown-item" href="../articles/accelerator.html">Accelerator API</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/lr-finder.html">Using the lr_finder</a></li>
    <li><a class="dropdown-item" href="../articles/checkpoints.html">Checkpoints models</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../articles/examples/index.html">Examples</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlverse/luz/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Resume training callback</h1>
      <small class="dont-index">Source: <a href="https://github.com/mlverse/luz/blob/main/R/callbacks-resume.R" class="external-link"><code>R/callbacks-resume.R</code></a></small>
      <div class="d-none name"><code>luz_callback_auto_resume.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This callback allows you to resume training a model.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">luz_callback_auto_resume</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"./state.pt"</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-path">path<a class="anchor" aria-label="anchor" href="#arg-path"></a></dt>
<dd><p>Path to save state files for the model.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>When using it, model weights, optimizer state are serialized at the end of
each epoch. If something fails during training simply re-running the same
script will restart the model training from the epoch right after the last
epoch that was serialized.</p>
    </div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>In general you will want to add this callback as the last in the callbacks
list, this way, the serialized state is likely to contain all possible changes
that other callbacks could have made at <code>'on_epoch_end'</code>. The default <code>weight</code>
attribute of this callback is <code>Inf</code>.</p>
<p>Read the checkpointing article in the pkgdown website for more
information.</p>
    </div>
    <div class="section level2">
    <h2 id="customizing-serialization">Customizing serialization<a class="anchor" aria-label="anchor" href="#customizing-serialization"></a></h2>



<p>By default model, optimizer state and records are serialized. Callbacks can
be used to customize serialization by implementing the <code>state_dict()</code> and
<code><a href="https://torch.mlverse.org/docs/reference/load_state_dict.html" class="external-link">load_state_dict()</a></code> methods.
If those methods are implemented, then <code>state_dict()</code> is called at the end of
each epoch and <code><a href="https://torch.mlverse.org/docs/reference/load_state_dict.html" class="external-link">load_state_dict()</a></code> is called when the model is resumed.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>Other luz_callbacks:
<code><a href="luz_callback.html">luz_callback</a>()</code>,
<code><a href="luz_callback_csv_logger.html">luz_callback_csv_logger</a>()</code>,
<code><a href="luz_callback_early_stopping.html">luz_callback_early_stopping</a>()</code>,
<code><a href="luz_callback_interrupt.html">luz_callback_interrupt</a>()</code>,
<code><a href="luz_callback_keep_best_model.html">luz_callback_keep_best_model</a>()</code>,
<code><a href="luz_callback_lr_scheduler.html">luz_callback_lr_scheduler</a>()</code>,
<code><a href="luz_callback_metrics.html">luz_callback_metrics</a>()</code>,
<code><a href="luz_callback_mixed_precision.html">luz_callback_mixed_precision</a>()</code>,
<code><a href="luz_callback_mixup.html">luz_callback_mixup</a>()</code>,
<code><a href="luz_callback_model_checkpoint.html">luz_callback_model_checkpoint</a>()</code>,
<code><a href="luz_callback_profile.html">luz_callback_profile</a>()</code>,
<code><a href="luz_callback_progress.html">luz_callback_progress</a>()</code>,
<code><a href="luz_callback_resume_from_checkpoint.html">luz_callback_resume_from_checkpoint</a>()</code>,
<code><a href="luz_callback_train_valid.html">luz_callback_train_valid</a>()</code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_is_installed.html" class="external-link">torch_is_installed</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlverse.github.io/luz/">luz</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">nn_linear</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="setup.html">setup</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="va">optim_sgd</span>, loss <span class="op">=</span> <span class="va">nnf_mse_loss</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="set_hparams.html">set_hparams</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">10</span>, out_features <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="set_opt_hparams.html">set_opt_hparams</a></span><span class="op">(</span>lr <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># simulate a failure in the middle of epoch 5 happening only once.</span></span></span>
<span class="r-in"><span><span class="va">callback_stop</span> <span class="op">&lt;-</span> <span class="fu"><a href="luz_callback.html">luz_callback</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="st">"interrupt"</span>,</span></span>
<span class="r-in"><span>  failed <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>  on_epoch_end <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="kw">if</span> <span class="op">(</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="va">self</span><span class="op">$</span><span class="va">failed</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="va">self</span><span class="op">$</span><span class="va">failed</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Error on epoch 5"</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">autoresume</span> <span class="op">&lt;-</span> <span class="fu">luz_callback_auto_resume</span><span class="op">(</span>path <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">interrupt</span> <span class="op">&lt;-</span> <span class="fu">callback_stop</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># try once and the model fails</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">autoresume</span>, <span class="va">interrupt</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># model resumes and completes</span></span></span>
<span class="r-in"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">autoresume</span>, <span class="va">interrupt</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="get_metrics.html">get_metrics</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Error in FUN(X[[i]], ...) : </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Error while calling callback with class <span style="color: #0000BB;">&lt;interrupt/LuzCallback/R6&gt;</span> at</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #00BB00;">on_epoch_end</span>.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="font-weight: bold;">Caused by error in `self[[callback_nm]]()`:</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BBBB00;">!</span> Error on epoch 5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      set metric epoch     value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1  train   loss     1 1.2031412</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2  train   loss     2 1.0665432</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3  train   loss     3 1.0337967</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4  train   loss     4 1.0160899</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5  train   loss     5 1.0213306</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6  train   loss     6 1.0118006</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7  train   loss     7 1.0143129</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 8  train   loss     8 1.0137992</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 9  train   loss     9 1.0156637</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10 train   loss    10 0.9987767</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel Falbel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

